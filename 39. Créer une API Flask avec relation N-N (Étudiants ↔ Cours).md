# <h1 id="cours-flask-nn">Cours – Créer une API Flask avec relation N\:N (Étudiants ↔ Cours)</h1>

## Objectif pédagogique

À la fin de ce cours, vous serez capable de :

* Créer deux modèles liés par une relation N\:N (plusieurs-à-plusieurs)
* Définir une **table d’association** manuelle dans SQLAlchemy
* Ajouter et récupérer des données via API REST
* Comprendre les principes d’un lien **symétrique** entre deux entités



## <h2 id="1-contexte">1. Contexte de la relation</h2>

### Exemple :

* Un étudiant peut suivre **plusieurs cours**
* Un cours peut être suivi par **plusieurs étudiants**



### Représentation logique (relation N\:N)

```
Etudiant (N) ──────< inscription >────── (N) Cours
```



## <h2 id="2-structure-projet">2. Structure du projet</h2>

```
projet_api_relation_nn/
├── env/
├── app.py
├── models.py
├── etudiants.db
```



## <h2 id="3-models-py">3. Modèle SQLAlchemy avec table d’association</h2>

**Fichier : `models.py`**

```python
from flask_sqlalchemy import SQLAlchemy

db = SQLAlchemy()

# Table d'association entre étudiants et cours
inscriptions = db.Table(
    "inscriptions",
    db.Column("etudiant_id", db.Integer, db.ForeignKey("etudiants.id"), primary_key=True),
    db.Column("cours_id", db.Integer, db.ForeignKey("cours.id"), primary_key=True)
)

class Etudiant(db.Model):
    __tablename__ = "etudiants"
    id = db.Column(db.Integer, primary_key=True)
    nom = db.Column(db.String(100), nullable=False)
    prenom = db.Column(db.String(100), nullable=False)

    cours = db.relationship("Cours", secondary=inscriptions, back_populates="etudiants")

    def to_dict(self):
        return {
            "id": self.id,
            "nom": self.nom,
            "prenom": self.prenom,
            "cours": [c.titre for c in self.cours]
        }

class Cours(db.Model):
    __tablename__ = "cours"
    id = db.Column(db.Integer, primary_key=True)
    titre = db.Column(db.String(100), nullable=False)

    etudiants = db.relationship("Etudiant", secondary=inscriptions, back_populates="cours")

    def to_dict(self):
        return {
            "id": self.id,
            "titre": self.titre,
            "etudiants": [f"{e.prenom} {e.nom}" for e in self.etudiants]
        }
```



## <h2 id="4-app-py">4. Fichier principal Flask</h2>

**Fichier : `app.py`**

```python
from flask import Flask, request, jsonify
from models import db, Etudiant, Cours

app = Flask(__name__)
app.config["SQLALCHEMY_DATABASE_URI"] = "sqlite:///etudiants.db"
app.config["SQLALCHEMY_TRACK_MODIFICATIONS"] = False

db.init_app(app)

@app.before_first_request
def create_tables():
    db.create_all()
```



## <h2 id="5-routes-cours">5. Routes pour Cours</h2>

### a. Ajouter un cours

```python
@app.route("/api/cours", methods=["POST"])
def ajouter_cours():
    data = request.get_json()
    titre = data.get("titre")
    if not titre:
        return jsonify({"message": "Titre requis"}), 400
    cours = Cours(titre=titre)
    db.session.add(cours)
    db.session.commit()
    return jsonify(cours.to_dict()), 201
```



### b. Obtenir tous les cours

```python
@app.route("/api/cours", methods=["GET"])
def get_cours():
    cours = Cours.query.all()
    return jsonify([c.to_dict() for c in cours])
```



## <h2 id="6-routes-etudiants">6. Routes pour Étudiants</h2>

### a. Ajouter un étudiant

```python
@app.route("/api/etudiants", methods=["POST"])
def ajouter_etudiant():
    data = request.get_json()
    nom = data.get("nom")
    prenom = data.get("prenom")
    if not (nom and prenom):
        return jsonify({"message": "Champs requis"}), 400
    etudiant = Etudiant(nom=nom, prenom=prenom)
    db.session.add(etudiant)
    db.session.commit()
    return jsonify(etudiant.to_dict()), 201
```



### b. Obtenir tous les étudiants

```python
@app.route("/api/etudiants", methods=["GET"])
def get_etudiants():
    etudiants = Etudiant.query.all()
    return jsonify([e.to_dict() for e in etudiants])
```


## <h2 id="7-inscription-etudiant-cours">7. Inscrire un étudiant à un ou plusieurs cours</h2>

```python
@app.route("/api/etudiants/<int:id>/inscription", methods=["POST"])
def inscrire_etudiant(id):
    etudiant = Etudiant.query.get(id)
    if not etudiant:
        return jsonify({"message": "Étudiant introuvable"}), 404

    data = request.get_json()
    cours_ids = data.get("cours_ids", [])

    for cid in cours_ids:
        cours = Cours.query.get(cid)
        if cours and cours not in etudiant.cours:
            etudiant.cours.append(cours)

    db.session.commit()
    return jsonify(etudiant.to_dict())
```



## <h2 id="8-test">8. Test avec `curl` ou Postman</h2>

### a. Ajouter un étudiant

```bash
curl -X POST http://localhost:5000/api/etudiants \
-H "Content-Type: application/json" \
-d "{\"nom\": \"Faure\", \"prenom\": \"Claire\"}"
```

### b. Ajouter un cours

```bash
curl -X POST http://localhost:5000/api/cours \
-H "Content-Type: application/json" \
-d "{\"titre\": \"Python\"}"
```

### c. Inscrire l’étudiant (id=1) aux cours (ex: \[1, 2])

```bash
curl -X POST http://localhost:5000/api/etudiants/1/inscription \
-H "Content-Type: application/json" \
-d "{\"cours_ids\": [1]}"
```



## <h2 id="9-structure-finale">9. Structure finale du projet</h2>

```
projet_api_relation_nn/
├── app.py
├── models.py
├── etudiants.db
└── env/
```



## <h2 id="10-resume">10. Résumé pédagogique</h2>

| Élément                  | Fonction                                                     |
| ------------------------ | ------------------------------------------------------------ |
| `inscriptions`           | Table d’association entre étudiants et cours (relation N\:N) |
| `secondary=inscriptions` | Permet la liaison dans les deux `relationship()`             |
| `back_populates`         | Relation bidirectionnelle explicite                          |
| `to_dict()`              | Méthode de conversion vers un format JSON lisible            |
| `etudiant.cours`         | Accès direct aux cours inscrits pour un étudiant             |
| `cours.etudiants`        | Accès aux étudiants inscrits dans un cours                   |
