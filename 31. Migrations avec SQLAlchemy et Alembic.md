# EXERCICE PRATIQUE – Migrations avec SQLAlchemy et Alembic

## Prérequis: 

*Fichier 31*

## Objectif de l'exercice

Apprendre à gérer correctement l’évolution d’un schéma de base de données avec SQLAlchemy en utilisant **Alembic**, un outil professionnel de gestion des migrations.

Vous allez :

1. Configurer Alembic.
2. Générer des scripts de migration automatiquement.
3. Appliquer des migrations.
4. Valider la migration.



## Prérequis

* Projet existant fonctionnel (`Etudiant` et `CarteEtudiant` avec relation 1:1).
* Compréhension du fonctionnement de SQLAlchemy et PySide6.



## Situation initiale

### Structure initiale (déjà implémentée)

```python
class Etudiant(Base):
    __tablename__ = "etudiants"
    id = Column(Integer, primary_key=True)
    nom = Column(String)
    prenom = Column(String)
    carte = relationship("CarteEtudiant", back_populates="etudiant", uselist=False)

class CarteEtudiant(Base):
    __tablename__ = "cartes"
    id = Column(Integer, primary_key=True)
    numero = Column(String)
    etudiant_id = Column(Integer, ForeignKey("etudiants.id"), unique=True)
    etudiant = relationship("Etudiant", back_populates="carte")
```



## ÉTAPE 1 : Installer Alembic et Initialiser le projet

### 1.1 Installer Alembic

```bash
pip install alembic
```

### 1.2 Initialiser Alembic

Dans votre dossier projet :

```bash
alembic init migrations
```



## ÉTAPE 2 : Configurer Alembic (`alembic.ini` et `env.py`)

### 2.1 Modifier le fichier `alembic.ini`

```
sqlalchemy.url = sqlite:///etudiants_cartes.db
```

### 2.2 Modifier le fichier `migrations/env.py`

Importer vos modèles existants dans `env.py` :

```python
import sys
import os
sys.path.append(os.path.abspath('.'))

from database import Base  # Adapter selon votre fichier

target_metadata = Base.metadata
```



## ÉTAPE 3 : Générer la première migration (initiale)

```bash
alembic revision --autogenerate -m "Migration initiale"
```

Cela crée un script de migration automatique dans le dossier `migrations/versions/`.


## ÉTAPE 4 : Appliquer la migration initiale

```bash
alembic upgrade head
```

Votre base initiale est maintenant versionnée par Alembic.



## ÉTAPE 5 : Modifier le schéma (Nouvelles exigences)

Ajoutez dans votre fichier `database.py` les nouvelles colonnes :

```python
from datetime import datetime

class Etudiant(Base):
    __tablename__ = "etudiants"
    id = Column(Integer, primary_key=True)
    nom = Column(String, nullable=False)
    prenom = Column(String, nullable=False)
    email = Column(String, unique=True)        # Nouveau
    date_naissance = Column(Date)              # Nouveau
    carte = relationship("CarteEtudiant", back_populates="etudiant", uselist=False)

class CarteEtudiant(Base):
    __tablename__ = "cartes"
    id = Column(Integer, primary_key=True)
    numero = Column(String, nullable=False)
    date_emission = Column(DateTime, default=datetime.now)  # Nouveau
    date_expiration = Column(Date)                          # Nouveau
    statut = Column(String, default="active")               # Nouveau
    etudiant_id = Column(Integer, ForeignKey("etudiants.id"), unique=True)
    etudiant = relationship("Etudiant", back_populates="carte")
```



## ÉTAPE 6 : Générer la migration automatique vers la nouvelle version

```bash
alembic revision --autogenerate -m "Ajout email, dates et statut"
```

Vérifiez le fichier généré automatiquement dans `migrations/versions`.



## ÉTAPE 7 : Appliquer la nouvelle migration

```bash
alembic upgrade head
```

Votre base de données est maintenant à jour avec les nouvelles colonnes.



## ÉTAPE 8 : Vérifier la migration directement avec SQLAlchemy

### Créez un script `test_migration.py` :

```python
from database import session, Etudiant, CarteEtudiant
from datetime import datetime, date

def test_migration():
    e = Etudiant(nom="Test", prenom="Migration", email="test.migration@example.com", date_naissance=date(1999,1,1))
    c = CarteEtudiant(numero="TEST1234", date_emission=datetime.now(), date_expiration=date(2025,1,1), statut="active", etudiant=e)

    session.add(e)
    session.add(c)
    session.commit()

    etudiant = session.query(Etudiant).filter_by(email="test.migration@example.com").first()
    if etudiant:
        print("Étudiant ajouté:", etudiant.nom, etudiant.email)
        print("Carte associée:", etudiant.carte.numero, etudiant.carte.statut)
    else:
        print("Échec de la migration.")

if __name__ == "__main__":
    test_migration()
```

Exécutez ce test :

```bash
python test_migration.py
```



## TRAVAIL À FAIRE (obligatoire)

**A – Réaliser intégralement la migration Alembic**

1. Initialiser Alembic.
2. Générer la migration initiale automatique.
3. Modifier les modèles ORM pour les nouvelles colonnes.
4. Générer et appliquer la nouvelle migration.
5. Vérifier avec le script de test.

**B – Interface graphique (optionnel)**

* Adaptez votre interface PySide6 pour utiliser les nouveaux champs.
* Permettez la recherche par email et le filtrage par statut.



## Commandes résumées (sans emojis)

### Installer Alembic

```bash
pip install alembic
```

### Initialiser Alembic

```bash
alembic init migrations
```

### Modifier Alembic

```
sqlalchemy.url = sqlite:///etudiants_cartes.db
```

### Générer la migration initiale

```bash
alembic revision --autogenerate -m "Migration initiale"
```

### Appliquer la migration initiale

```bash
alembic upgrade head
```

### Générer migration après modifications

```bash
alembic revision --autogenerate -m "Ajout email, dates et statut"
```

### Appliquer cette migration

```bash
alembic upgrade head
```

### Revenir à la version précédente (optionnel)

```bash
alembic downgrade -1
```



## Critères de succès

* La migration Alembic s'applique sans erreur.
* Toutes les nouvelles colonnes sont créées et opérationnelles.
* Le script de test fonctionne correctement.



## En résumé :

Cette méthode utilisant Alembic est la façon professionnelle et officielle de gérer proprement l’évolution d’une base de données avec SQLAlchemy, similaire à Prisma Migrate.

Vous avez maintenant un contrôle complet et structuré sur vos migrations SQLAlchemy grâce à Alembic.




<br/>

# Annexe 1 - modification de migrations/env.py




```python
from logging.config import fileConfig

from sqlalchemy import engine_from_config
from sqlalchemy import pool

from alembic import context

# ✅ AJOUT : importer sys et os pour localiser vos fichiers Python
import os  # ✅ AJOUT
import sys  # ✅ AJOUT

# ✅ AJOUT : ajouter le chemin courant pour pouvoir importer `database.py`
sys.path.append(os.path.abspath("."))  # ✅ AJOUT

# ✅ AJOUT : importer Base depuis votre fichier database.py
from database import Base  # ✅ AJOUT

# this is the Alembic Config object, which provides
# access to the values within the .ini file in use.
config = context.config

# Interpret the config file for Python logging.
# This line sets up loggers basically.
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# ✅ MODIFICATION : affecter la métadonnée des modèles
target_metadata = Base.metadata  # ✅ MODIFICATION

# other values from the config, defined by the needs of env.py,
# can be acquired:
# my_important_option = config.get_main_option("my_important_option")
# ... etc.


def run_migrations_offline() -> None:
    """Run migrations in 'offline' mode.

    This configures the context with just a URL
    and not an Engine, though an Engine is acceptable
    here as well.  By skipping the Engine creation
    we don't even need a DBAPI to be available.

    Calls to context.execute() here emit the given string to the
    script output.

    """
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
    )

    with context.begin_transaction():
        context.run_migrations()


def run_migrations_online() -> None:
    """Run migrations in 'online' mode.

    In this scenario we need to create an Engine
    and associate a connection with the context.

    """
    connectable = engine_from_config(
        config.get_section(config.config_ini_section, {}),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(
            connection=connection, target_metadata=target_metadata
        )

        with context.begin_transaction():
            context.run_migrations()


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()
```



## ✅ Résultat

Avec ces modifications :

* Alembic **connait maintenant vos modèles SQLAlchemy**.
* Vous pouvez exécuter :

  ```bash
  alembic revision --autogenerate -m "Migration initiale"
  ```

  …et il générera correctement la structure des tables définies dans `database.py`.




<br/>

<br/>

# Annexe 2 - Guide de gestion des migrations Alembic avec SQLAlchemy

## Objectif

Ce document explique comment :

* Générer des fichiers de migration automatiquement avec Alembic.
* Appliquer ces migrations à la base de données.
* Suivre une logique incrémentale sur 5 évolutions successives du modèle.


## Prérequis

* Projet SQLAlchemy fonctionnel (`database.py` avec `Base`, `Etudiant`, etc.).
* Base SQLite (`etudiants_cartes.db`).
* Alembic installé :

  ```bash
  pip install alembic
  ```



## Initialisation (à faire une seule fois)

### 1. Initialiser le dossier `migrations/`

```bash
alembic init migrations
```

Si le dossier existe déjà, ne pas réexécuter cette commande.

### 2. Modifier les fichiers de configuration

#### a. `alembic.ini`

Remplacer :

```
sqlalchemy.url = driver://user:pass@localhost/dbname
```

par :

```
sqlalchemy.url = sqlite:///etudiants_cartes.db
```

#### b. `migrations/env.py`

Modifier cette partie :

```python
target_metadata = None
```

En important votre base :

```python
import os
import sys
sys.path.append(os.path.abspath("."))
from database import Base
target_metadata = Base.metadata
```



## Cycle de migration Alembic

À chaque fois que vous modifiez vos modèles SQLAlchemy (`database.py`), suivez les étapes suivantes.



# MIGRATION 1 — Modèle de base (Etudiant + CarteEtudiant)

### Étape 1 : Générer la migration

```bash
alembic revision --autogenerate -m "Migration initiale"
```

### Étape 2 : Appliquer cette migration

```bash
alembic upgrade head
```


# MIGRATION 2 — Ajout d'un champ `email` à `Etudiant`

### Étape 1 : Modifier le modèle

Dans `Etudiant`, ajouter :

```python
email = Column(String, unique=True)
```

### Étape 2 : Générer la migration

```bash
alembic revision --autogenerate -m "Ajout champ email"
```

### Étape 3 : Appliquer la migration

```bash
alembic upgrade head
```



# MIGRATION 3 — Ajout de `date_naissance` à `Etudiant`

### Étape 1 : Modifier le modèle

```python
from datetime import date
...
date_naissance = Column(Date)
```

### Étape 2 : Générer et appliquer

```bash
alembic revision --autogenerate -m "Ajout date_naissance"
alembic upgrade head
```



# MIGRATION 4 — Ajout de `date_emission` à `CarteEtudiant`

### Étape 1 : Modifier `CarteEtudiant`

```python
from datetime import datetime
...
date_emission = Column(DateTime, default=datetime.now)
```

### Étape 2 : Générer et appliquer

```bash
alembic revision --autogenerate -m "Ajout date_emission"
alembic upgrade head
```



# MIGRATION 5 — Ajout de `statut` à `CarteEtudiant`

### Étape 1 : Ajouter la colonne

```python
statut = Column(String, default="active")
```

### Étape 2 : Générer et appliquer

```bash
alembic revision --autogenerate -m "Ajout statut"
alembic upgrade head
```



## Commandes utiles

| Action                          | Commande                                       |
| ------------------------------- | ---------------------------------------------- |
| Générer une migration           | `alembic revision --autogenerate -m "message"` |
| Appliquer toutes les migrations | `alembic upgrade head`                         |
| Revenir à la version précédente | `alembic downgrade -1`                         |
| Lister les versions disponibles | `alembic history`                              |
| Connaître la version actuelle   | `alembic current`                              |


## Bonnes pratiques

* Ne jamais modifier manuellement les fichiers dans `migrations/versions/` sauf pour des ajustements bien compris.
* Toujours appliquer les migrations avant d'en générer de nouvelles.
* Ajouter un commentaire significatif dans le `-m "..."` pour suivre l'historique.



## Vérification

Vous pouvez créer un script `test_migration.py` pour insérer un enregistrement avec tous les champs modifiés et vérifier visuellement qu’ils ont été bien ajoutés.

